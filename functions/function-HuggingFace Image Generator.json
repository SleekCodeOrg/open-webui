[{"id":"huggingface_image_generator","name":"HuggingFace Image Generator","meta":{"description":"HuggingFace API integration for Open WebUI","type":"pipe","manifest":{"title":"Hugging Face API - Flux Pro Image Generator","author":"Alick","version":"0.0.0","license":"MIT","description":"Open WebUI Function Pipe - 使用 Hugging Face 文生图 API 生成图片，支持提示词里自定义宽高"},"user":{"id":"060a60ee-e8b3-4dba-a06d-9f564b414d4d","username":"alick","name":"","createdAt":1741668020,"role":null,"verified":false},"id":"0a1fb27d-45dd-4709-b36a-96e2bb99d9f3"},"content":"\"\"\"\ntitle: Hugging Face API - Flux Pro Image Generator\nauthor: Alick\nversion: 0.0.0\nlicense: MIT\ndescription: Open WebUI Function Pipe - 使用 Hugging Face 文生图 API 生成图片，支持提示词里自定义宽高\n\"\"\"\n\nimport requests\nimport uuid\nimport os\nimport re\nfrom pydantic import BaseModel, Field\nfrom typing import Union, Iterator, Generator\nfrom open_webui.config import CACHE_DIR\n\n\nclass Pipe:\n    class Valves(BaseModel):\n        HF_API_KEY: str = Field(\n            default=\"\",\n            description=\"HuggingFace API key for accessing the serverless endpoints\",\n        )\n        HF_API_URL: str = Field(\n            default=\"https://api-inference.huggingface.co/models/stabilityai/stable-diffusion-3.5-large-turbo\",\n            description=\"HuggingFace API URL for accessing the Text-to-Image model.\",\n        )\n\n    def __init__(self):\n        self.id = \"huggingface_image_generator\"\n        self.type = \"function\"\n        self.name = \"Hugging Face Image Generator\"\n        self.valves = self.Valves()\n\n    def pipe(self, body: dict) -> Union[str, Generator, Iterator]:\n        messages = body.get(\"messages\", [])\n        prompt = body.get(\"prompt\", \"\").strip()\n        if not prompt:\n            for m in reversed(messages):\n                if m.get(\"role\") == \"user\":\n                    prompt = m.get(\"content\", \"\").strip()\n                    break\n\n        if not self.valves.HF_API_KEY:\n            return (\n                \"Error: 尚未配置 Hugging Face API Key，请在 valves 中设置 HF_API_KEY。\"\n            )\n\n        formats = {\n            \"default\": (1024, 1024),\n            \"square\": (1024, 1024),\n            \"landscape\": (1024, 768),\n            \"landscape_large\": (1440, 1024),\n            \"portrait\": (768, 1024),\n            \"portrait_large\": (1024, 1440),\n        }\n        image_format = body.get(\"image_format\", \"default\")\n        if image_format not in formats:\n            return \"Error: 无效的 image_format，合法值：\" + \", \".join(formats.keys())\n\n        width, height = formats[image_format]\n\n        match = re.search(r\"(\\d+)\\s*[x×\\*]\\s*(\\d+)\", prompt)\n        if match:\n            w, h = map(int, match.groups())\n            width, height = w, h\n\n        headers = {\n            \"Authorization\": f\"Bearer {self.valves.HF_API_KEY}\",\n            \"Content-Type\": \"application/json\",\n        }\n        payload = {\n            \"inputs\": prompt,\n            \"parameters\": {\n                \"width\": width,\n                \"height\": height,\n            },\n        }\n\n        try:\n            response = requests.post(\n                self.valves.HF_API_URL,\n                headers=headers,\n                json=payload,\n                timeout=600,\n            )\n            if response.status_code != 200:\n                return (\n                    f\"Error: 模型推理请求失败。\\n\"\n                    f\"HTTP状态码: {response.status_code}\\n\"\n                    f\"响应信息: {response.text}\"\n                )\n\n            image_content = response.content\n            directory = os.path.join(CACHE_DIR, \"image\", \"generations\")\n            os.makedirs(directory, exist_ok=True)\n\n            filename = f\"{uuid.uuid4()}.png\"\n            save_path = os.path.join(directory, filename)\n\n            with open(save_path, \"wb\") as f:\n                f.write(image_content)\n\n            image_url = f\"/cache/image/generations/{filename}\"\n            result_md = (\n                f\"**已为你的提示词生成图片**：\\n\\n\" f\"![Generated Image]({image_url})\"\n            )\n            return result_md\n\n        except requests.RequestException as e:\n            return f\"Error: 网络异常或连接失败。\\n{str(e)}\"\n        except Exception as e:\n            return f\"Error: 未知异常。\\n{str(e)}\"\n"}]